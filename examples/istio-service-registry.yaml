#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Istio Service Registry Configuration Example
# This example demonstrates how to configure Dubbo-Kubernetes to use Istio as a service registry

apiVersion: v1
kind: ConfigMap
metadata:
  name: dubbo-istio-config
  namespace: dubbo-system
data:
  # Istio Pilot configuration
  istio.pilot.address: "istiod.istio-system.svc.cluster.local:15010"
  istio.namespace: "istio-system"
  istio.tls.enabled: "true"
  istio.sync.timeout: "30s"

  # Service discovery configuration
  istio.enable.discovery: "true"
  istio.service.name: "dubbo-control-plane"
  istio.service.version: "v1"

  # TLS certificate paths (optional, for mTLS)
  # istio.cert.path: "/etc/certs/cert.pem"
  # istio.key.path: "/etc/certs/key.pem"
  # istio.ca.path: "/etc/certs/ca.pem"

---
# Deployment example for Dubbo Sail Discovery with Istio
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dubbo-sail-discovery
  namespace: dubbo-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dubbo-sail-discovery
  template:
    metadata:
      labels:
        app: dubbo-sail-discovery
      annotations:
        sidecar.istio.io/inject: "true"
    spec:
      containers:
        - name: discovery
          image: dubbo/sail-discovery:latest
          args:
            - --registries=Istio
            - --istio-pilot-address=istiod.istio-system.svc.cluster.local:15010
            - --istio-namespace=istio-system
            - --istio-tls-enabled=true
            - --istio-service-name=dubbo-control-plane
            - --istio-service-version=v1
          ports:
            - containerPort: 18000
              name: grpc
            - containerPort: 8080
              name: http
          env:
            - name: PILOT_ADDRESS
              value: "istiod.istio-system.svc.cluster.local:15010"
            - name: ISTIO_NAMESPACE
              value: "istio-system"
            - name: TLS_ENABLED
              value: "true"
          volumeMounts:
            - name: config
              mountPath: /etc/dubbo
            - name: certs
              mountPath: /etc/certs
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: dubbo-istio-config
        - name: certs
          secret:
            secretName: dubbo-istio-certs
            optional: true

---
# Service for Dubbo Sail Discovery
apiVersion: v1
kind: Service
metadata:
  name: dubbo-sail-discovery
  namespace: dubbo-system
  labels:
    app: dubbo-sail-discovery
spec:
  selector:
    app: dubbo-sail-discovery
  ports:
    - name: grpc
      port: 18000
      targetPort: 18000
      protocol: TCP
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP

---
# Optional: ServiceMonitor for Prometheus monitoring
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: dubbo-sail-discovery
  namespace: dubbo-system
spec:
  selector:
    matchLabels:
      app: dubbo-sail-discovery
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
