import{u as se}from"./index-m1J7Dgwm.js";import{d as ie,g as ce,u as de,n as K,r as ue,Q as re,f as H,c as e,t as a,e as n,o as m,z as u,v as w,h as D,a9 as pe,aa as _e,F as fe,y as ye,J as x,B as R,I as P,K as z,G as ve,H as be,_ as he}from"./index-uR6obgcO.js";import{e as me,h as ke}from"./traffic-8AWvGuIw.js";import"./js-yaml-lTHa-xT-.js";import"./request-QeNrWFvM.js";const N=V=>(ve("data-v-297b685f"),V=V(),be(),V),we={class:"__container_tagRule_detail"},xe={style:{"max-width":"400px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},ge=N(()=>x("br",null,null,-1)),Ce=N(()=>x("br",null,null,-1)),$e=N(()=>x("br",null,null,-1)),Ue=N(()=>x("br",null,null,-1)),Ke=N(()=>x("br",null,null,-1)),Oe=N(()=>x("br",null,null,-1)),je={class:"bottom-action-footer"},Ne=ie({__name:"updateByFormView",setup(V){ce();const E=de(),O=K(!1),L=K(8);se().toClipboard;const q=(t,o)=>{var r,g,k,b;let y=`对于服务 ${o||"未指定"}，将满足 `;const v=[];if(((r=t.scope)==null?void 0:r.type)==="labels"&&((g=t.scope.labels)==null?void 0:g.length)>0)t.scope.labels.forEach(s=>{var h,_;let p="";if(s.myKey==="method")p="请求方法";else if((h=s.myKey)!=null&&h.startsWith("args[")){const T=(_=s.myKey.match(/\\[(\\d+)\\]/))==null?void 0:_[1];T!==void 0?p=`第 ${parseInt(T)+1} 个参数`:p=`标签 ${s.myKey||"未指定"}`}else p=`标签 ${s.myKey||"未指定"}`;let c="";const d=s.value||"未指定";switch(s.condition){case"exact":c=`等于 ${d}`;break;case"regex":c=`匹配正则 ${d}`;break;case"prefix":c=`前缀为 ${d}`;break;case"noempty":c="不为空";break;case"empty":c="为空";break;case"wildcard":c=`匹配通配符 ${d}`;break;case"!=":c=`不等于 ${d}`;break;default:c=`${s.condition||"未知关系"} ${d}`}s.condition!=="empty"&&s.condition!=="noempty"&&!s.value?v.push(`${p} 未填写`):v.push(`${p} ${c}`)});else if(((k=t.scope)==null?void 0:k.type)==="addresses"&&((b=t.scope.addresses)!=null&&b.addressesStr)){const s=t.scope.addresses.condition==="="?"等于":"不等于";v.push(`地址 ${s} [${t.scope.addresses.addressesStr}]`)}return v.length===0?y+="任意请求":y+=v.join(" 且 "),y+=` 的请求，导向带有标签 ${t.tagName||"未指定"} 的实例`,y},i=ue({ruleGranularity:"application",objectOfAction:"shop-user",enable:!0,faultTolerantProtection:!0,runtime:!0,priority:1,configVersion:""}),J=K([{label:"labels",value:"labels"},{label:"addresses",value:"addresses"}]),M=K([{label:"exact",value:"exact"},{label:"regex",value:"regex"},{label:"prefix",value:"prefix"},{label:"noempty",value:"noempty"},{label:"empty",value:"empty"},{label:"wildcard",value:"wildcard"}]),Q=K([{label:"=",value:"="},{label:"!=",value:"!="}]),W=K([{title:"键",dataIndex:"myKey",key:"myKey"},{title:"关系",dataIndex:"condition",key:"condition"},{title:"值",dataIndex:"value",key:"value"},{title:"操作",dataIndex:"operation",key:"operation"}]),f=K([]),X=(t,o)=>{if(f.value[t].scope.labels.length===1){f.value[t].scope.type="addresses";return}f.value[t].scope.labels.splice(o,1)},Y=t=>{f.value[t].scope.labels.push({myKey:"",condition:"exact",value:""})},Z=()=>{f.value.push({tagName:"",scope:{type:"labels",labels:[{myKey:"",condition:"",value:""}],addresses:{condition:"",addressesStr:""}}})},I=t=>{f.value.splice(t,1)},F=async()=>{var o;const t=await me((o=E.params)==null?void 0:o.ruleName);if(t.code===200){const{configVersion:y,enabled:v,key:r,runtime:g,scope:k,tags:b}=t==null?void 0:t.data;i.configVersion=y,i.enable=v,i.runtime=g,i.ruleGranularity=k,i.objectOfAction=r,f.value=[],b.forEach((s,p)=>{f.value.push({tagName:s.name,scope:{type:"labels",labels:[],addresses:{condition:"=",addressesStr:""}}});const{match:c}=s;let d=[];c.forEach((h,_)=>{d.push({myKey:h.key,condition:Object.keys(h.value)[0],value:h.value[Object.keys(h.value)[0]]})}),f.value[p]&&f.value[p].scope&&(f.value[p].scope.labels=d)})}},ee=async()=>{var p;const{ruleGranularity:t,objectOfAction:o,enable:y,faultTolerantProtection:v,runtime:r,priority:g,configVersion:k}=i,b={configVersion:k,scope:t,key:o,enabled:y,runtime:r,tags:[]};f.value.forEach((c,d)=>{const h={name:c.tagName,match:[]};c.scope.labels.forEach((_,T)=>{const A={key:_.myKey,value:{}};A.value[_.condition]=_.value,h.match.push(A)}),b.tags.push(h)}),(await ke((p=E.params)==null?void 0:p.ruleName,b)).code===200&&await F()};return re(()=>{F()}),(t,o)=>{const y=n("a-button"),v=n("a-flex"),r=n("a-form-item"),g=n("a-switch"),k=n("a-col"),b=n("a-input"),s=n("a-input-number"),p=n("a-row"),c=n("a-form"),d=n("a-card"),h=n("a-tooltip"),_=n("a-space"),T=n("a-radio-group"),A=n("a-tag"),G=n("a-select"),ae=n("a-table"),te=n("a-textarea"),B=n("a-descriptions-item"),le=n("a-descriptions"),oe=n("a-affix");return m(),H("div",we,[e(v,{style:{width:"100%"}},{default:a(()=>[e(k,{span:O.value?24-L.value:24,class:"left"},{default:a(()=>[e(d,null,{default:a(()=>[e(_,{style:{width:"100%"},direction:"vertical",size:"middle"},{default:a(()=>[e(p,null,{default:a(()=>[e(v,{justify:"end",style:{width:"100%"}},{default:a(()=>[e(y,{type:"text",style:{color:"#0a90d5"},onClick:o[0]||(o[0]=l=>O.value=!O.value)},{default:a(()=>[u(" 字段说明 "),O.value?(m(),w(D(_e),{key:1})):(m(),w(D(pe),{key:0}))]),_:1})]),_:1}),e(d,{title:"基础信息",style:{width:"100%"},class:"_detail"},{default:a(()=>[e(c,{layout:"horizontal"},{default:a(()=>[e(p,{style:{width:"100%"}},{default:a(()=>[e(k,{span:12},{default:a(()=>[e(r,{label:"规则粒度",required:""},{default:a(()=>[u(" 应用 ")]),_:1}),e(r,{label:"容错保护"},{default:a(()=>[e(g,{checked:i.faultTolerantProtection,"onUpdate:checked":o[1]||(o[1]=l=>i.faultTolerantProtection=l),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),e(r,{label:"运行时生效"},{default:a(()=>[e(g,{checked:i.runtime,"onUpdate:checked":o[2]||(o[2]=l=>i.runtime=l),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1})]),_:1}),e(k,{span:12},{default:a(()=>[e(r,{label:"作用对象",required:""},{default:a(()=>[e(b,{disabled:"",value:i.objectOfAction,"onUpdate:value":o[3]||(o[3]=l=>i.objectOfAction=l),style:{width:"200px"}},null,8,["value"])]),_:1}),e(r,{label:"立即启用"},{default:a(()=>[e(g,{checked:i.enable,"onUpdate:checked":o[4]||(o[4]=l=>i.enable=l),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),e(r,{label:"优先级"},{default:a(()=>[e(s,{min:"1",value:i.priority,"onUpdate:value":o[5]||(o[5]=l=>i.priority=l)},null,8,["value"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(d,{title:"标签列表",style:{width:"100%"},class:"_detail"},{default:a(()=>[(m(!0),H(fe,null,ye(f.value,(l,S)=>(m(),w(d,{key:S},{title:a(()=>[e(_,{align:"center"},{default:a(()=>[x("div",null,"路由【"+R(S+1)+"】",1),e(h,null,{title:a(()=>[u(R(q(l,i.objectOfAction)),1)]),default:a(()=>[x("div",xe,R(q(l,i.objectOfAction)),1)]),_:2},1024)]),_:2},1024)]),default:a(()=>[e(c,{layout:"horizontal"},{default:a(()=>[e(_,{style:{width:"100%"},direction:"vertical",size:"large"},{default:a(()=>[e(v,{justify:"end"},{default:a(()=>[e(D(P),{onClick:$=>I(S),class:"action-icon",icon:"tdesign:delete"},null,8,["onClick"])]),_:2},1024),e(r,{label:"标签名",required:""},{default:a(()=>[e(b,{placeholder:"隔离环境名",value:l.tagName,"onUpdate:value":$=>l.tagName=$},null,8,["value","onUpdate:value"])]),_:2},1024),e(r,{label:"作用范围",required:""},{default:a(()=>[e(d,null,{default:a(()=>[e(_,{style:{width:"100%"},direction:"vertical"},{default:a(()=>[e(r,{label:"匹配条件类型"},{default:a(()=>[e(T,{value:l.scope.type,"onUpdate:value":$=>l.scope.type=$,options:J.value},null,8,["value","onUpdate:value","options"])]),_:2},1024),e(_,{align:"start",style:{width:"100%"},direction:"horizontal"},{default:a(()=>{var $;return[e(A,{bordered:!1,color:"processing"},{default:a(()=>[u(R(l.scope.type),1)]),_:2},1024),l.scope.type==="labels"?(m(),w(ae,{key:0,pagination:!1,columns:W.value,"data-source":($=l.scope)==null?void 0:$.labels},{bodyCell:a(({column:C,record:j,text:Te,index:ne})=>[C.key==="myKey"?(m(),w(b,{key:0,placeholder:"label key",value:j.myKey,"onUpdate:value":U=>j.myKey=U},null,8,["value","onUpdate:value"])):z("",!0),C.key==="condition"?(m(),w(G,{key:1,value:j.condition,"onUpdate:value":U=>j.condition=U,style:{width:"120px"},options:M.value},null,8,["value","onUpdate:value","options"])):z("",!0),C.key==="value"?(m(),w(b,{key:2,placeholder:"label value",value:j.value,"onUpdate:value":U=>j.value=U},null,8,["value","onUpdate:value"])):C.key==="operation"?(m(),w(_,{key:3,align:"center"},{default:a(()=>[e(D(P),{icon:"tdesign:remove",class:"action-icon",onClick:U=>X(S,ne)},null,8,["onClick"]),e(D(P),{class:"action-icon",icon:"tdesign:add",onClick:U=>Y(S)},null,8,["onClick"])]),_:2},1024)):z("",!0)]),_:2},1032,["columns","data-source"])):(m(),w(_,{key:1,align:"start"},{default:a(()=>[e(G,{style:{width:"120px"},value:l.scope.addresses.condition,"onUpdate:value":C=>l.scope.addresses.condition=C,options:Q.value},null,8,["value","onUpdate:value","options"]),e(te,{style:{width:"500px"},value:l.scope.addresses.addressesStr,"onUpdate:value":C=>l.scope.addresses.addressesStr=C,placeholder:'地址列表，如有多个用"，"隔开'},null,8,["value","onUpdate:value"])]),_:2},1024))]}),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(y,{onClick:Z,type:"primary"},{default:a(()=>[u(" 增加标签")]),_:1})]),_:1})]),_:1})]),_:1},8,["span"]),e(k,{span:O.value?L.value:0,class:"right"},{default:a(()=>[O.value?(m(),w(d,{key:0,class:"sliderBox"},{default:a(()=>[x("div",null,[e(le,{title:"字段说明",column:1},{default:a(()=>[e(B,{label:"key"},{default:a(()=>[u(" 作用对象"),ge,u(" 可能的值：Dubbo应用名或者服务名 ")]),_:1}),e(B,{label:"scope"},{default:a(()=>[u(" 规则粒度"),Ce,u(" 可能的值：application, service ")]),_:1}),e(B,{label:"force"},{default:a(()=>[u(" 容错保护"),$e,u(" 可能的值：true, false"),Ue,u(" 描述：如果为true，则路由筛选后若没有可用的地址则会直接报异常；如果为false，则会从可用地址中选择完成RPC调用 ")]),_:1}),e(B,{label:"runtime"},{default:a(()=>[u(" 运行时生效"),Ke,u(" 可能的值：true, false"),Oe,u(" 描述：如果为true，则该rule下的所有路由将会实时生效；若为false，则只有在启动时才会生效 ")]),_:1})]),_:1})])]),_:1})):z("",!0)]),_:1},8,["span"])]),_:1}),e(oe,{"offset-bottom":10},{default:a(()=>[x("div",je,[e(_,{align:"center",size:"large"},{default:a(()=>[e(y,{type:"primary",onClick:ee},{default:a(()=>[u(" 确认")]),_:1}),e(y,null,{default:a(()=>[u(" 取消")]),_:1})]),_:1})])]),_:1})])}}}),Re=he(Ne,[["__scopeId","data-v-297b685f"]]);export{Re as default};
