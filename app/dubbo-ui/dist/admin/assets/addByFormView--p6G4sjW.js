import{u as ne}from"./index-DoPOcYH8.js";import{d as se,g as ie,u as ce,n as K,b as de,r as ue,f as F,c as e,t,e as n,o as _,z as i,v as m,h as B,a9 as re,aa as pe,F as _e,y as fe,J as k,B as z,I as P,K as A,G as ye,H as ve,_ as be}from"./index-_X3VxdTR.js";import{f as he}from"./traffic-tUIc0SS0.js";import"./request-da1buChK.js";const S=D=>(ye("data-v-943c684d"),D=D(),ve(),D),me={class:"__container_tagRule_detail"},ke={style:{"max-width":"400px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},xe=S(()=>k("br",null,null,-1)),we=S(()=>k("br",null,null,-1)),ge=S(()=>k("br",null,null,-1)),$e=S(()=>k("br",null,null,-1)),Ce=S(()=>k("br",null,null,-1)),Ue=S(()=>k("br",null,null,-1)),Ke={class:"bottom-action-footer"},Oe=se({__name:"addByFormView",setup(D){ie(),ce();const O=K(!1),L=K(8);ne().toClipboard;const G=de(),q=(l,o)=>{var u,g,v,b;let f=`对于服务 ${o||"未指定"}，将满足 `;const y=[];if(((u=l.scope)==null?void 0:u.type)==="labels"&&((g=l.scope.labels)==null?void 0:g.length)>0)l.scope.labels.forEach(s=>{var $,d;let h="";if(s.myKey==="method")h="请求方法";else if(($=s.myKey)!=null&&$.startsWith("args[")){const T=(d=s.myKey.match(/\\[(\\d+)\\]/))==null?void 0:d[1];T!==void 0?h=`第 ${parseInt(T)+1} 个参数`:h=`标签 ${s.myKey||"未指定"}`}else h=`标签 ${s.myKey||"未指定"}`;let c="";const r=s.value||"未指定";switch(s.condition){case"exact":c=`等于 ${r}`;break;case"regex":c=`匹配正则 ${r}`;break;case"prefix":c=`前缀为 ${r}`;break;case"noempty":c="不为空";break;case"empty":c="为空";break;case"wildcard":c=`匹配通配符 ${r}`;break;case"!=":c=`不等于 ${r}`;break;default:c=`${s.condition||"未知关系"} ${r}`}s.condition!=="empty"&&s.condition!=="noempty"&&!s.value?y.push(`${h} 未填写`):y.push(`${h} ${c}`)});else if(((v=l.scope)==null?void 0:v.type)==="addresses"&&((b=l.scope.addresses)!=null&&b.addressesStr)){const s=l.scope.addresses.condition==="="?"等于":"不等于";y.push(`地址 ${s} [${l.scope.addresses.addressesStr}]`)}return y.length===0?f+="任意请求":f+=y.join(" 且 "),f+=` 的请求，导向带有标签 ${l.tagName||"未指定"} 的实例`,f},p=ue({ruleGranularity:"application",objectOfAction:"",enable:!0,faultTolerantProtection:!0,runtime:!0,priority:1,configVersion:"v3.0"}),H=K([{label:"labels",value:"labels"},{label:"addresses",value:"addresses"}]),J=K([{label:"exact",value:"exact"},{label:"regex",value:"regex"},{label:"prefix",value:"prefix"},{label:"noempty",value:"noempty"},{label:"empty",value:"empty"},{label:"wildcard",value:"wildcard"}]),W=K([{label:"=",value:"="},{label:"!=",value:"!="}]),M=K([{title:"键",dataIndex:"myKey",key:"myKey"},{title:"关系",dataIndex:"condition",key:"condition"},{title:"值",dataIndex:"value",key:"value"},{title:"操作",dataIndex:"operation",key:"operation"}]),x=K([]),Q=(l,o)=>{if(x.value[l].scope.labels.length===1){x.value[l].scope.type="addresses";return}x.value[l].scope.labels.splice(o,1)},X=l=>{x.value[l].scope.labels.push({myKey:"",condition:"exact",value:""})},Y=()=>{x.value.push({tagName:"",scope:{type:"labels",labels:[{myKey:"",condition:"",value:""}],addresses:{condition:"",addressesStr:""}}})},Z=l=>{x.value.splice(l,1)},I=async()=>{const{ruleGranularity:l,objectOfAction:o,enable:f,faultTolerantProtection:y,runtime:u,priority:g,configVersion:v}=p,b={configVersion:v,scope:l,key:o,enabled:f,runtime:u,tags:[]};x.value.forEach((c,r)=>{const $={name:c.tagName,match:[]};c.scope.labels.forEach((d,T)=>{const R={key:d.myKey,value:{}};R.value[d.condition]=d.value,$.match.push(R)}),b.tags.push($)});let s="";l=="application"?s=`${o}.tag-router`:s=`${o}:${v}.tag-router`,(await he(s,b)).code===200&&G.push("/traffic/tagRule")};return(l,o)=>{const f=n("a-button"),y=n("a-flex"),u=n("a-form-item"),g=n("a-switch"),v=n("a-col"),b=n("a-input"),s=n("a-input-number"),h=n("a-row"),c=n("a-form"),r=n("a-card"),$=n("a-tooltip"),d=n("a-space"),T=n("a-radio-group"),R=n("a-tag"),E=n("a-select"),ee=n("a-table"),te=n("a-textarea"),V=n("a-descriptions-item"),ae=n("a-descriptions"),le=n("a-affix");return _(),F("div",me,[e(y,{style:{width:"100%"}},{default:t(()=>[e(v,{span:O.value?24-L.value:24,class:"left"},{default:t(()=>[e(r,null,{default:t(()=>[e(d,{style:{width:"100%"},direction:"vertical",size:"middle"},{default:t(()=>[e(h,null,{default:t(()=>[e(y,{justify:"end",style:{width:"100%"}},{default:t(()=>[e(f,{type:"text",style:{color:"#0a90d5"},onClick:o[0]||(o[0]=a=>O.value=!O.value)},{default:t(()=>[i(" 字段说明 "),O.value?(_(),m(B(pe),{key:1})):(_(),m(B(re),{key:0}))]),_:1})]),_:1}),e(r,{title:"基础信息",style:{width:"100%"},class:"_detail"},{default:t(()=>[e(c,{layout:"horizontal"},{default:t(()=>[e(h,{style:{width:"100%"}},{default:t(()=>[e(v,{span:12},{default:t(()=>[e(u,{label:"规则粒度",required:""},{default:t(()=>[i(" 应用 ")]),_:1}),e(u,{label:"容错保护"},{default:t(()=>[e(g,{checked:p.faultTolerantProtection,"onUpdate:checked":o[1]||(o[1]=a=>p.faultTolerantProtection=a),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),e(u,{label:"运行时生效"},{default:t(()=>[e(g,{checked:p.runtime,"onUpdate:checked":o[2]||(o[2]=a=>p.runtime=a),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1})]),_:1}),e(v,{span:12},{default:t(()=>[e(u,{label:"作用对象",required:""},{default:t(()=>[e(b,{value:p.objectOfAction,"onUpdate:value":o[3]||(o[3]=a=>p.objectOfAction=a),style:{width:"200px"}},null,8,["value"])]),_:1}),e(u,{label:"立即启用"},{default:t(()=>[e(g,{checked:p.enable,"onUpdate:checked":o[4]||(o[4]=a=>p.enable=a),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),e(u,{label:"优先级"},{default:t(()=>[e(s,{min:"1",value:p.priority,"onUpdate:value":o[5]||(o[5]=a=>p.priority=a)},null,8,["value"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(r,{title:"标签列表",style:{width:"100%"},class:"_detail"},{default:t(()=>[(_(!0),F(_e,null,fe(x.value,(a,j)=>(_(),m(r,{key:j},{title:t(()=>[e(d,{align:"center"},{default:t(()=>[k("div",null,"路由【"+z(j+1)+"】",1),e($,null,{title:t(()=>[i(z(q(a,p.objectOfAction)),1)]),default:t(()=>[k("div",ke,z(q(a,p.objectOfAction)),1)]),_:2},1024)]),_:2},1024)]),default:t(()=>[e(c,{layout:"horizontal"},{default:t(()=>[e(d,{style:{width:"100%"},direction:"vertical",size:"large"},{default:t(()=>[e(y,{justify:"end"},{default:t(()=>[e(B(P),{onClick:C=>Z(j),class:"action-icon",icon:"tdesign:delete"},null,8,["onClick"])]),_:2},1024),e(u,{label:"标签名",required:""},{default:t(()=>[e(b,{placeholder:"隔离环境名",value:a.tagName,"onUpdate:value":C=>a.tagName=C},null,8,["value","onUpdate:value"])]),_:2},1024),e(u,{label:"作用范围",required:""},{default:t(()=>[e(r,null,{default:t(()=>[e(d,{style:{width:"100%"},direction:"vertical"},{default:t(()=>[e(u,{label:"匹配条件类型"},{default:t(()=>[e(T,{value:a.scope.type,"onUpdate:value":C=>a.scope.type=C,options:H.value},null,8,["value","onUpdate:value","options"])]),_:2},1024),e(d,{align:"start",style:{width:"100%"},direction:"horizontal"},{default:t(()=>{var C;return[e(R,{bordered:!1,color:"processing"},{default:t(()=>[i(z(a.scope.type),1)]),_:2},1024),a.scope.type==="labels"?(_(),m(ee,{key:0,pagination:!1,columns:M.value,"data-source":(C=a.scope)==null?void 0:C.labels},{bodyCell:t(({column:w,record:N,text:Ne,index:oe})=>[w.key==="myKey"?(_(),m(b,{key:0,placeholder:"label key",value:N.myKey,"onUpdate:value":U=>N.myKey=U},null,8,["value","onUpdate:value"])):A("",!0),w.key==="condition"?(_(),m(E,{key:1,value:N.condition,"onUpdate:value":U=>N.condition=U,style:{width:"120px"},options:J.value},null,8,["value","onUpdate:value","options"])):A("",!0),w.key==="value"?(_(),m(b,{key:2,placeholder:"label value",value:N.value,"onUpdate:value":U=>N.value=U},null,8,["value","onUpdate:value"])):w.key==="operation"?(_(),m(d,{key:3,align:"center"},{default:t(()=>[e(B(P),{icon:"tdesign:remove",class:"action-icon",onClick:U=>Q(j,oe)},null,8,["onClick"]),e(B(P),{class:"action-icon",icon:"tdesign:add",onClick:U=>X(j)},null,8,["onClick"])]),_:2},1024)):A("",!0)]),_:2},1032,["columns","data-source"])):(_(),m(d,{key:1,align:"start"},{default:t(()=>[e(E,{style:{width:"120px"},value:a.scope.addresses.condition,"onUpdate:value":w=>a.scope.addresses.condition=w,options:W.value},null,8,["value","onUpdate:value","options"]),e(te,{style:{width:"500px"},value:a.scope.addresses.addressesStr,"onUpdate:value":w=>a.scope.addresses.addressesStr=w,placeholder:'地址列表，如有多个用"，"隔开'},null,8,["value","onUpdate:value"])]),_:2},1024))]}),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(f,{onClick:Y,type:"primary"},{default:t(()=>[i(" 增加标签")]),_:1})]),_:1})]),_:1})]),_:1},8,["span"]),e(v,{span:O.value?L.value:0,class:"right"},{default:t(()=>[O.value?(_(),m(r,{key:0,class:"sliderBox"},{default:t(()=>[k("div",null,[e(ae,{title:"字段说明",column:1},{default:t(()=>[e(V,{label:"key"},{default:t(()=>[i(" 作用对象"),xe,i(" 可能的值：Dubbo应用名或者服务名 ")]),_:1}),e(V,{label:"scope"},{default:t(()=>[i(" 规则粒度"),we,i(" 可能的值：application, service ")]),_:1}),e(V,{label:"force"},{default:t(()=>[i(" 容错保护"),ge,i(" 可能的值：true, false"),$e,i(" 描述：如果为true，则路由筛选后若没有可用的地址则会直接报异常；如果为false，则会从可用地址中选择完成RPC调用 ")]),_:1}),e(V,{label:"runtime"},{default:t(()=>[i(" 运行时生效"),Ce,i(" 可能的值：true, false"),Ue,i(" 描述：如果为true，则该rule下的所有路由将会实时生效；若为false，则只有在启动时才会生效 ")]),_:1})]),_:1})])]),_:1})):A("",!0)]),_:1},8,["span"])]),_:1}),e(le,{"offset-bottom":10},{default:t(()=>[k("div",Ke,[e(d,{align:"center",size:"large"},{default:t(()=>[e(f,{type:"primary",onClick:I},{default:t(()=>[i(" 确认")]),_:1}),e(f,null,{default:t(()=>[i(" 取消")]),_:1})]),_:1})])]),_:1})])}}}),De=be(Oe,[["__scopeId","data-v-943c684d"]]);export{De as default};
