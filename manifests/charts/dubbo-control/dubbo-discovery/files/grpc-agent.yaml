# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

metadata:
  annotations:
    dubbo.apache.org/rev: default
spec:
  # NOTE:
  #   Application containers that rely on this template must mount the same "dubbo-data"
  #   volume at /var/lib/dubbo/data and set GRPC_XDS_EXPERIMENTAL_SECURITY_SUPPORT=true
  #   in order for proxyless gRPC security (mTLS) to pick up the certificates generated
  #   by the dubbo-proxy sidecar.
  containers:
    - name: dubbo-proxy
      image: "{{ $.ProxyImage }}"
      imagePullPolicy: Always
      ports:
        - containerPort: 15020
          protocol: TCP
          name: mesh-metrics
      args:
        - proxy
        - --domain
        - $(POD_NAMESPACE).svc.cluster.local
      lifecycle:
        postStart:
          exec:
            command:
#              - dubbo-agent
              - planet-agent
              - wait
              - --url=http://localhost:15020/healthz/ready
      readinessProbe:
        failureThreshold: 4
        httpGet:
          path: /healthz/ready
          port: 15020
          scheme: HTTP
        periodSeconds: 15
        successThreshold: 1
        timeoutSeconds: 3
        initialDelaySeconds: 30
      env:
        - name: DUBBO_META_GENERATOR
          value: grpc
        - name: GRPC_XDS_BOOTSTRAP
          value: /etc/dubbo/proxy/grpc-bootstrap.json
        - name: OUTPUT_CERTS
          value: /var/lib/dubbo/data
        - name: DUBBO_CERT_PROVIDER
          value: dubbod
        - name: DUBBO_META_CLUSTER_ID
          value: Kubernetes
        - name: DUBBO_META_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: CA_ADDR
          value: dubbod.dubbo-system.svc:15012
        - name: DUBBO_META_MESH_ID
          value: cluster.local
        - name: TRUST_DOMAIN
          value: cluster.local
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: SERVICE_ACCOUNT
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
      volumeMounts:
        - mountPath: /var/lib/dubbo/data
          name: dubbo-data
        - mountPath: /etc/dubbo/proxy
          name: dubbo-xds
        - mountPath: /var/run/secrets/workload-spiffe-uds
          name: workload-socket
        - mountPath: /var/run/secrets/workload-spiffe-credentials
          name: workload-certs
        - mountPath: /etc/dubbo/pod
          name: dubbo-podinfo
        - mountPath: /var/run/secrets/dubbo
          name: dubbod-ca-cert
  volumes:
    - emptyDir:
        medium: Memory
      name: dubbo-xds
    - emptyDir: {}
      name: dubbo-data
    - emptyDir: {}
      name: workload-socket
    - emptyDir: {}
      name: workload-certs
    - downwardAPI:
        defaultMode: 420
        items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.labels
            path: labels
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.annotations
            path: annotations
      name: dubbo-podinfo
    - configMap:
        defaultMode: 420
        name: dubbo-ca-root-cert
      name: dubbod-ca-cert