# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Load Test Server Deployment
# Supports three test modes:
#   - baseline: Regular gRPC without any service mesh (no annotations needed)
#   - envoy: Standard gRPC with Istio Envoy sidecar proxy (add sidecar.istio.io/inject: "true")
#   - xds: Proxyless gRPC using xDS resolver (add proxyless.dubbo.apache.org/inject: "true")
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loadtest-server
  namespace: loadtest
  labels:
    app: loadtest-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loadtest-server
  template:
    metadata:
      labels:
        app: loadtest-server
      annotations:
        # Mode switching guide:
        # Baseline mode: Comment out or remove all annotations (no sidecar injection)
        # Envoy mode: Uncomment the following line to enable Istio sidecar injection
        # sidecar.istio.io/inject: "true"
        # xDS mode: Uncomment the following annotations to enable Dubbo proxyless injection
        # proxyless.dubbo.apache.org/inject: "true"
        # inject.dubbo.apache.org/templates: grpc-agent
        # proxy.dubbo.apache.org/config: '{"holdApplicationUntilProxyStarts": true}'
    spec:
      containers:
      - name: server
        # Replace with your own image containing the loadtest server binary
        image: mfordjody/loadtest-server:dev-debug
        imagePullPolicy: Always
        args:
        - "-port=8080"
        # Server mode: baseline, envoy, or xds
        # baseline: Regular gRPC server without xDS (no control plane needed)
        # envoy: Regular gRPC server (Envoy sidecar handles routing, requires Istio)
        # xds: xDS-enabled gRPC server using xds.NewGRPCServer() (requires Dubbo control plane)
        - "-mode=baseline"
        env:
        - name: TEST_MODE
          # Change to: baseline, envoy, or xds (must match args mode above)
          value: "baseline"
        # Note: args use literal values, not env var substitution. Update args when changing TEST_MODE.
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.podIP
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        ports:
        - containerPort: 8080
          protocol: TCP
          name: grpc
        readinessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 2
          periodSeconds: 3
          timeoutSeconds: 1
          successThreshold: 1
          failureThreshold: 3
        livenessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 1
          successThreshold: 1
          failureThreshold: 3
        startupProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 0
          periodSeconds: 1
          timeoutSeconds: 1
          successThreshold: 1
          failureThreshold: 30
---
apiVersion: v1
kind: Service
metadata:
  name: loadtest-server
  namespace: loadtest
  labels:
    app: loadtest-server
spec:
  selector:
    app: loadtest-server
  type: ClusterIP
  ports:
  - name: grpc
    port: 8080
    targetPort: 8080
    protocol: TCP
---
# Load Test Client Job
# Runs load test against the server with configurable parameters
# Supports three test modes matching the server mode
# Note: This Job will wait for the server to be ready before starting the test
apiVersion: batch/v1
kind: Job
metadata:
  name: loadtest-client
  namespace: loadtest
spec:
  template:
    metadata:
      labels:
        app: loadtest-client
      annotations:
        # Mode switching guide:
        # Baseline mode: Comment out or remove all annotations (no sidecar injection)
        # Envoy mode: Uncomment the following line to enable Istio sidecar injection
        # sidecar.istio.io/inject: "true"
        # xDS mode: Uncomment the following annotations to enable Dubbo proxyless injection
        # proxyless.dubbo.apache.org/inject: "true"
        # inject.dubbo.apache.org/templates: grpc-agent
        # proxy.dubbo.apache.org/config: '{"holdApplicationUntilProxyStarts": true}'
    spec:
      containers:
      - name: client
        # Replace with your own image containing the loadtest client binary
        image: mfordjody/loadtest-client:dev-debug
        imagePullPolicy: Always
        args:
        # Target server address
        # baseline/envoy mode: use regular service address
        # xds mode: use xds:/// scheme (e.g., xds:///loadtest-server.loadtest.svc.cluster.local:8080)
        - "-target=loadtest-server.loadtest.svc.cluster.local:8080"
        # Client mode: baseline, envoy, or xds (must match server mode)
        # baseline: Regular gRPC client connection (no control plane needed)
        # envoy: Regular gRPC client (traffic goes through Envoy sidecar, requires Istio)
        # xds: xDS-enabled gRPC client using xds:/// scheme (requires Dubbo control plane)
        - "-mode=baseline"
        - "-qps=100"        # Queries per second
        - "-duration=60s"    # Test duration
        - "-connections=4"   # Number of concurrent connections
        env:
        - name: TEST_MODE
          # Change to: baseline, envoy, or xds (must match args mode above)
          value: "baseline"
        # Note: args use literal values, not env var substitution. Update args when changing TEST_MODE or TARGET.
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.podIP
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
      restartPolicy: Never
  backoffLimit: 1
