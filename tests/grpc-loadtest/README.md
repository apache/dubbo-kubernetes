# gRPC Load Test Framework

This is a load testing framework similar to Fortio, designed to compare performance across three different gRPC communication modes:

1. **Baseline**: Regular gRPC without Envoy proxy or proxyless xDS
2. **Envoy**: Standard Istio Agent + Envoy proxy sidecar
3. **xds:/// Proxyless**: Client uses xDS gRPC server implementation and resolver

## Architecture

The framework consists of:

- **Server**: gRPC server that can run in three modes (baseline, envoy, xds)
- **Client**: Load testing client (similar to Fortio) that can test all three modes
- **Kubernetes Manifests**: Deployment files for all three test scenarios

## Resource Requirements

Based on the experimental setup:

- **GKE 1.20 cluster**: 3 nodes of e2-standard-16 (16 CPU + 64 GB RAM each)
- **Fortio client/server applications**: 1.5 vCPU, 1000 MiB memory
- **Sidecar** (istio-agent and possible Envoy proxy): 1 vCPU, 512 MiB memory

## Building

### Prerequisites

- Go 1.24+
- Protocol Buffers compiler (protoc)
- Docker (for building images)

### Generate Proto Code

```bash
cd tests/grpc-loadtest/proto
chmod +x gen.sh
./gen.sh
```

### Build Locally

```bash
cd tests/grpc-loadtest
go build -o server ./server
go build -o client ./client
```

### Build Docker Images

```bash
# Build server image
docker build -t loadtest-server:latest -f Dockerfile .

# Build client image (same Dockerfile)
docker build -t loadtest-client:latest -f Dockerfile .
```

## Usage

### Server

Start the server in one of three modes:

```bash
# Baseline mode
./server -port=8080 -mode=baseline

# Envoy mode (regular gRPC, Envoy sidecar handles routing)
./server -port=8080 -mode=envoy

# xDS proxyless mode
./server -port=8080 -mode=xds
```

### Client

Run load tests against the server:

```bash
# Test baseline mode
./client \
  -target=localhost:8080 \
  -mode=baseline \
  -qps=100 \
  -duration=60s \
  -connections=4

# Test Envoy mode
./client \
  -target=localhost:8080 \
  -mode=envoy \
  -qps=100 \
  -duration=60s \
  -connections=4

# Test xDS proxyless mode
./client \
  -target=xds:///service.namespace.svc.cluster.local:8080 \
  -mode=xds \
  -qps=100 \
  -duration=60s \
  -connections=4
```

### Client Options

- `-target`: Target server address (use `xds:///` scheme for xDS mode)
- `-mode`: Client mode: `baseline`, `envoy`, or `xds`
- `-qps`: Queries per second (default: 10)
- `-duration`: Test duration (e.g., `30s`, `5m`)
- `-connections`: Number of concurrent connections (default: 1)
- `-payload`: Payload size in bytes (default: 0)
- `-timeout`: Request timeout (default: 30s)

## Kubernetes Deployment

### Deploy Servers

```bash
# Deploy baseline server
kubectl apply -f k8s/baseline-server.yaml

# Deploy Envoy server (requires Istio)
kubectl apply -f k8s/envoy-server.yaml

# Deploy xDS proxyless server (requires Dubbo control plane)
kubectl apply -f k8s/xds-server.yaml
```

### Run Load Tests

```bash
# Test baseline
kubectl apply -f k8s/client-job.yaml
kubectl logs -f job/loadtest-client-baseline -n grpc-loadtest

# Test Envoy
kubectl logs -f job/loadtest-client-envoy -n grpc-loadtest

# Test xDS proxyless
kubectl logs -f job/loadtest-client-xds -n grpc-loadtest
```

## Test Scenarios

### 1. Baseline Test

Regular gRPC communication without any service mesh components:

```bash
# Server
./server -port=8080 -mode=baseline

# Client
./client -target=localhost:8080 -mode=baseline -qps=100 -duration=60s
```

### 2. Envoy Test

Standard Istio setup with Envoy sidecar proxy:

```bash
# Server (with Istio sidecar injection)
kubectl apply -f k8s/envoy-server.yaml

# Client (with Istio sidecar injection)
./client -target=loadtest-server-envoy.grpc-loadtest.svc.cluster.local:8080 \
  -mode=envoy -qps=100 -duration=60s
```

### 3. xDS Proxyless Test

Client uses native gRPC xDS resolver (requires Dubbo control plane):

```bash
# Server (with dubbo-proxy sidecar)
kubectl apply -f k8s/xds-server.yaml

# Client (with dubbo-proxy sidecar)
./client -target=xds:///loadtest-server-xds.grpc-loadtest.svc.cluster.local:8080 \
  -mode=xds -qps=100 -duration=60s
```

## Output

The client outputs detailed statistics:

```
=== Load Test Results ===
Duration: 60s
Total Requests: 6000
Successful: 6000
Errors: 0
Average QPS: 100.00

Latency Percentiles:
  P50: 2.5ms
  P90: 5.2ms
  P95: 7.8ms
  P99: 12.3ms
  P99.9: 25.6ms
```

## Comparison

Run all three tests and compare:

1. **Latency**: P50, P90, P95, P99, P99.9 percentiles
2. **Throughput**: QPS achieved
3. **Error Rate**: Percentage of failed requests
4. **Resource Usage**: CPU and memory consumption

## Notes

- For xDS mode, the `GRPC_XDS_BOOTSTRAP` environment variable must point to a valid bootstrap file
- The bootstrap file is typically generated by the `dubbo-proxy` sidecar
- Envoy mode requires Istio to be installed in the cluster
- xDS proxyless mode requires Dubbo control plane to be running

## References

- [Istio Proxyless gRPC Blog Post](https://istio.io/latest/blog/2021/proxyless-grpc/)
- [Fortio Load Testing Tool](https://github.com/fortio/fortio)
- [gRPC xDS Documentation](https://github.com/grpc/grpc-go/tree/master/xds)

